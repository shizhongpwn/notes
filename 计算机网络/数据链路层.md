# 数据链路层

> 数据链路层属于计算机网络的底层。

数据链路层的相关信道：

* 点对点信道：这种信道使用点对点的通信方式。
* 广播信道：一对多的广播通信方式，因此信道多的情况下，需要使用共享信道协议，

从整个互联网来看，局域网是属于数据链路层的，因为网络层其实讨论的是怎么从一个网络传输到另一个网络的问题。

路局在网络中的流动：

![image-20201030143548339](数据链路层.assets/image-20201030143548339.png)

## 点对点信道的数据链路层

数据链路：物理线路+必要的通信协议+必要软件，其中实现协议的最常用的方法是使用`网络适配器（包括硬件和软件）`,一般的网络适配器都包括数据链路层和物理层两个功能。

帧：数据链路层的协议数据单元。

数据链路层的作用：把网络层交下来的数据发送到链路上，把收到的帧里面的数据取出交给网络层。

点对点通信的主要步骤：

* 节点A的数据链路层把网络层交下来的IP数据报，添加首部和尾部封装成帧。
* 节点A把封装好的帧发送给节点B的数据链路层
* B确定数据链路层过来的帧没有错误之后，从中提取IP数据交给网络层，否则进行丢弃。

数据链路层协议的三个基本问题`封装成帧`，`透明传输`,`差错检测`。

数据链路层相关协议的三个基本问题：

* 封装成帧：
  * 这个其实就是在一段数据前后分别天剑首部和尾部，这样就构成了一个帧，那么接收端就可以根据首部和尾部的标识，从比特流里面识别出帧的开始和结束，所以首部和尾部的作用就是`帧定界`，同时首部和尾部还包含很多的控制信息。
  * 值得注意的是每一种链路层协议都规定了所能传送的帧的`数据部分长度上限-最大传送单元MTU(Maximum Transfer Unit)`。
  * ![image-20201106154210302](数据链路层.assets/image-20201106154210302.png)
  * 如果数据是由可打印的ASCII码组成的文本文件时,`帧定界符`可以是特殊字符，ASCII码是七位编码，128种不同的ascii码，其中可打印的95个，不可打印的控制字符33个，我们就可以使用控制字符`SOH(Start Of Header)`放在一个帧的最前面，另一个`EOT(End Of Transmission)`放在最后面表示开始和结束。![image-20201106154637706](数据链路层.assets/image-20201106154637706.png)
  * `帧界定符`的一个很重要的作用就是判断数据包是否完整，知道哪些数据包无效哪些是可以接收的。
  
* 透明传输：
  * 如上用专门的控制字符表示开始和结束的时候，我们发送的数据段就不可以存在这些字符，当然对于ASCII文本信息，自然是不可能包含这些不可打印的字符的，但是如果不是ASCIi文本信息怎么办？此时如果使用如上的控制字符，当数据段包含这些字符的时候就会引发错误![image-20201106155027459](数据链路层.assets/image-20201106155027459.png)这就不是一种透明传输。
  * `透明`:某一个实际存在的事务看起来却好像不存在一样，这其实表示数据可以无差错通过数据链路层，所以数据链路层就好像`透明`一样。
  * 为了实现透明传输：我们把数据中可能出现的控制字符前面插入转义字符`ESC`,但是在数据链路层发送数据到网络层 之前，需要删除这个插入的转义字符，改方法称为`字节填充`。![image-20201106162553564](数据链路层.assets/image-20201106162553564.png)
  
* 差错检测：
  * `比特差错`:比特流传输过程中，可能产生差错，1变0，0变1.
  * 误码率EBR（Bit Error Rate）:传输错误的比特占所传输比特总数的比率。
  * `循环冗余检验CRC(Cyclic Redundancy Check)`:假设我们现在发送数据`M=101001(k=6)` , CRC运算就是添加供差错检查用的n位`冗余码`。
  * `冗余码计算方法`：用二进制的模2运算进行2的n次方乘以M的运算，相当于M后面加了n个0，得到的（k+n）位的数除以收发双方事先商定的长度（n+1）的除数P，得出的商是Q，余数是R.
    * 假设`P=1101`那么mod2除法运算之后商`Q=110101`![image-20201106165534192](数据链路层.assets/image-20201106165534192.png)余数就是`R=001`这个余数就作为冗余码拼接在M的后面发送出去。
    * 这种为了进行检错添加的冗余码常称为`帧检验序列FCS(Frame Check Sequence)`,那么上面的那个结果就是`101001001`（k+n位）。
  * `接收端以帧位单位进行CRC检验`：把收到的每一帧都除以同样的除数P（mod 2计算），检查得到的余数R，如果传输没有差错，那么余数一定是0。![image-20201106171000361](数据链路层.assets/image-20201106171000361.png)
  * `CRC检查总结`：
    * 余数为0，表示正确
    * 余数不等于0，出现错误，但是无法确定是哪一位或者那几位出现了错误，丢弃改数据包。
    * 那么如果仅仅使用`CRC `进行检测，那么只能保证`凡是接受端数据链路层接受的帧均无差错`，因为有错误的都被丢弃了，但是这并不算是`可靠传输服务`，`可靠传输服务应该保证发送段的发送都被接收端正确的接收`。
  
  只是通过`CRC`校验的haul是无法保证`可靠传输的`，`可靠传输`就是客户端发什么接收端都要接受什么。
  
  `传输差错`：
  
  * 基本的比特差错，就如上。
  * 复杂错误。
    * 帧丢失
    * 帧重复
    * 帧失序
  
  
  
  
  
## 点对点协议PPP

  > PPP协议就是用户计算机和ISP进行通信所使用的数据链路层协议，TCP/IP协议簇里面可靠传输由运输层TCP协议负责。那么PPP协议不需要纠错，设置序号，流量控制等，同时只支持点对点的链路通信，只支持全双工链路。

  协议需求：

  * 简单
    * 就一个CRC校验
  * 封装成帧
    * PPP协议规定特殊字符为`帧定界符`。
  * 透明性
    * 必须有效解决，数据帧中的数据段出现`帧界定符`的情况
  * 多种网络层协议
    * 可以再同一条物理链路上同时支持多种网络层协议。
      * 就比如点对点连接的是局域网或者路由器的话，PPP协议必须同时支持所连接的局域网或者路由器上运行的各种网咯层协议。
  * 差错检测。
  * 检测连接状态
    * 可以及时检测链路是否处于正常的工作状态。
  * 最大传输单元`MUT`
    * MTU是数据链路层的帧可以载荷的`数据部分`的最大长度。
  * 数据压缩商
    * 提供一种方法来协商使用的数据压缩算法，但是PPP协议并不要求将数据压缩算法标准化。

`PPP协议组成`

1. 将IP数据报装到串行链路的方法，PPP只出异步链路和同步链路。
2. 一个用来建立配置和测试数据链路的`链路控制协议LCP`
3. 一套网络控制协议`NCP`.

`PPP协议帧格式`

1. 各个字段的意义
   1. ![image-20201113152740279](数据链路层.assets/image-20201113152740279.png)
   2. `帧界定符`:`0x7E`
   3. 地址字段A
   4. 控制字段C
   5. 第四个字段是两字节的协议字段
      1. 0x0021  --->   IP数据报
      2. 0xC)21  ----> `链路控制协议LCP`数据
      3. 0x8021 -----> 网络层控制数据
      4. 尾部第一个字段 CRC 的帧检验序列FCS
2. 字节填充
   1. ![image-20201113153248473](数据链路层.assets/image-20201113153248473.png)
3. 0比特填充
   1. ![image-20201113153340605](数据链路层.assets/image-20201113153340605.png)

`PPP协议的工作状态`

`ppp`链路初始化：

1. 用户拨号接入ISP
2. 个人PC发送`LCP`分组（配置请求帧，PPP帧），建立`LCP`连接
3. 网络层配置：NCP给PC分配临时IP

`PPP协议结束`

1. NCP释放网络连接
2. LCP释放数据链路层连接。
3. 物理层释放连接

![image-20201113160043101](数据链路层.assets/image-20201113160043101.png)






















# 网络层

互联网的设计思路：**网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务**。

* 网络层不提供服务质量的承诺，数据报传输可能出错，丢失等等。
* 如果需要可靠通信的话，我们就可以在运输层里面进行实现。

上面设计思路的优点在于：

* 极大的降低了网络中路由器的造价，运行方式灵活，可以适用多种应用。

![image-20201215205113131](网络层.assets/image-20201215205113131.png)

虚电路表示只是逻辑上的连接，分组都沿着这条逻辑连接按照存储转发的方式传送，而不是真正建立了一条物理连接。

![image-20201215210715986](网络层.assets/image-20201215210715986.png)

## 网际协议IP

与IP协议配套使用的三个协议

1. 地址解析协议ARP
2. 网际控制报文协议ICMP
3. 网际管理协议IGMP

![image-20201215211324299](网络层.assets/image-20201215211324299.png)

`虚拟互联网络`

> 没有一种单一的网络能够适应所有用户的需求。

网络有很多种，而且层出不穷，连接网络需要中间设备：

1. 物理层使用的中间设备：`转发器`
2. 数据链路层使用的中间设备：`网桥`或者`桥接器`。
3. 网络层使用的中间设备`路由器`
4. 网络层以上使用的中间设备叫做`网关`，网关连接两个不兼容的系统需要在高层进行协议转换。

![image-20201215212749427](网络层.assets/image-20201215212749427.png)

物理网络的异构性本来是客观存在的，但是我们利用`IP协议`就可以使得这些性能各异的网络在网络层看起来好像是一个统一的网络。

分组传送问题：

![image-20201215213510383](网络层.assets/image-20201215213510383.png)

H1发送数据报给H2

1. H1检查自己的路由表，如果查到说明H2在本网络，所以直接交付。
2. 如果不是，那么就发送给某个路由器进行间接交付。

上图还有一个结论:`互联网可以由多个异构网络互连组成`。

`分类的IP地址`

IP地址由`互联网名字和数字分配机构ICANN`进行分配。

IP地址的编址的发展：

1. 分类的IP地址。
2. 子网的划分
3. 构成超网。

下面说下分类的IP地址。

IP地址识别：

![image-20201215214742137](网络层.assets/image-20201215214742137.png)

1. 第一个字段是网络号，用来标识所连接到的网络，这个是唯一的。
2. 第二个字段是主机号，标识该主机，一个主机号在它的网络号指明的网络范围内必须是唯一的。

A类地址里面，本机软件环回测试地址的网络号127

A类地址主机号：全0表示主机所在的网络地址，例如`5.0.0.0`，全表示该网络的所有主机。

B类网络的`128.0.0.0`是不指派的，其最小的可指派网络地址是`128.1.0.0`。

C类网络最小网络地址`192.0.1.0`。

![image-20201218181745936](网络层.assets/image-20201218181745936.png)

![image-20201218181755673](网络层.assets/image-20201218181755673.png)

在互联网里面，一个网络是指具有相同网络号`net-id`的集合，因此，用转发器或者网桥连接起来的若干个局域网仍然为一个网络。

互联网平等的对待每一个IP地址。

两个路由器直接相连的时候，在连线的两端可以不分配IP地址，如果分配了，那么就构成了一段特殊的网络，因为它有IP，但是经常是不分配IP地址，叫做`无编号网络或者无名网络`。

`IP地址与硬件地址`

IP地址放在IP数据报的首部，硬件地址放在MAC帧的首部。在网络层和网络层以上使用IP地址，数据链路层及其以下用硬件地址。

注意IP数据报放入数据链路层的MAC帧之后，数据链路层看不到数据包IP的IP地址。

![image-20201219200205819](网络层.assets/image-20201219200205819.png)

从上图可以看出虚拟互联网和实际链路之间的关系。

`地址解析协议ARP`

![image-20201219202109888](网络层.assets/image-20201219202109888.png)

地址解析协议ARP解决这个问题的方法就是在主机ARP高速缓存里面放一个IP地址到硬件地址的映射表，并且这个映射表还经常动态的更新。

每个主机都设有一个`ARP高数缓存`，里面有本局域网上各主机和路由器的IP地址到硬件地址的映射表。

ARP步骤：

1. 主机A的ARP进程在本局域网广播发送一个ARP请求分组。![image-20201219204217867](网络层.assets/image-20201219204217867.png)
2. 本局域网所有主机运行的ARP进程都收到此ARP请求分组。
3. 主机B的IP地址与ARP请求分组中要查询的IP地址一致，就收下这个分组，然后向A发送响应分组，同时在响应分组里面写入自己的硬件地址。![image-20201219205445028](网络层.assets/image-20201219205445028.png)
4. 主机A收到响应分组之后，就在其ARP高速缓存里面写入主机BIP地址到硬件地址的映射。

值得注意的是：主机A发送的ARP分组里面已经包含了自己的IP地址到MAC地址的映射。
`IP数据报的格式`

![image-20201219210345629](网络层.assets/image-20201219210345629.png)

我们知道数据链路层有一个数据字段的最大长度，称为最大传送单元MTU，所以IP数据报封装成数据链路层帧的时候总长度不可以超过这个，过长 的数据报要进行`分片处理`。

IP协议规定：`互联网中所有的主机和路由器，都必须能够接受长度不超过576字节的数据报。`所以当主机发送超过576字节的数据报的时候应该确认一下目的主机是否接受数据报的长度，否则要进行分片处理。

分片操作（此时数据报首部的“总长度”字段是指分片后每一个分片的首部长度和该分片的数据长度的总和。）：

1. 标识，相同标识字段的值使得分片后的数据报片可以组装回原来的数据报。
2. 标志（3位）
   1. 最低位MF = 1表示还有分片 = 0表示是分片的最后一个。
   2. 中间位 DF 表示不能分片 DF = 0时才可以分片。
   3. 最前位尚无作用。
3. 13位，某片相当于原分组中的相对位置。































